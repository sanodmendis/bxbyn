name: Build Release EXE

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Inject Database Configuration
        shell: bash
        run: |
          sed -i '/import io\.github\.cdimascio\.dotenv\.Dotenv;/d' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java
          sed -i '/private static final Dotenv dotenv = Dotenv\.load();/d' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java

          sed -i 's/private static final String HOST = dotenv\.get("DB_HOST");/private static final String HOST = "${{ secrets.DB_HOST }}";/' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java
          sed -i 's/private static final String PORT = dotenv\.get("DB_PORT");/private static final String PORT = "${{ secrets.DB_PORT }}";/' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java
          sed -i 's/private static final String DATABASE = dotenv\.get("DB_NAME");/private static final String DATABASE = "${{ secrets.DB_NAME }}";/' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java
          sed -i 's/private static final String USERNAME = dotenv\.get("DB_USER");/private static final String USERNAME = "${{ secrets.DB_USER }}";/' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java
          sed -i 's/private static final String PASSWORD = dotenv\.get("DB_PASS");/private static final String PASSWORD = "${{ secrets.DB_PASS }}";/' src/main/java/com/sanodmendis/bxbyn/database/DBConnection.java

      - name: Build Maven Project (JAR)
        run: mvn -B clean package

      - name: Detect Built JAR Filename
        id: detectjar
        shell: pwsh
        run: |
          $jar = Get-ChildItem -Path "target" -Filter "*.jar" | Where-Object { $_.Name -notmatch "original" } | Select-Object -First 1
          if (-not $jar) {
            Write-Error "No JAR file found in target/"
          }
          Write-Host "Detected JAR: $($jar.Name)"
          echo "JAR_NAME=$($jar.Name)" >> $env:GITHUB_OUTPUT

      ###############################################################
      # EXE WITHOUT JRE
      ###############################################################
      - name: Create EXE (no JRE)
        shell: pwsh
        run: |
          jpackage `
            --type exe `
            --input target `
            --main-jar "${{ steps.detectjar.outputs.JAR_NAME }}" `
            --name "YourApp" `
            --dest dist

      ###############################################################
      # CUSTOM JRE + EXE WITH JRE
      ###############################################################
      - name: Create Custom JRE (jlink)
        shell: pwsh
        run: |
          jlink `
            --no-header-files `
            --no-man-pages `
            --strip-debug `
            --compress=2 `
            --output customjre `
            --add-modules java.base,java.sql

      - name: Create EXE with Embedded JRE
        shell: pwsh
        run: |
          jpackage `
            --type exe `
            --input target `
            --main-jar "${{ steps.detectjar.outputs.JAR_NAME }}" `
            --runtime-image customjre `
            --name "YourApp-JRE" `
            --dest dist

      ###############################################################
      # RELEASE ALL FILES
      ###############################################################
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            target/*.jar
            dist/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
